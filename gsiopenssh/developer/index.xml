<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<?asciidoc-toc?>
<?asciidoc-numbered?>

<book lang="en">
<bookinfo>
    <title>GT 6.0 GSI-OpenSSH: Developer&#8217;s Guide</title>
</bookinfo>
<preface>
<title></title>
<simpara>This document provides information for GSI-OpenSSH developers.
The changes to <ulink url="http://www.openssh.org/">OpenSSH</ulink> to add GSI support are
limited, because we build on the existing GSSAPI support in OpenSSH for
Kerberos. See the
<ulink url="http://dev.globus.org/wiki/GSI-OpenSSH/Internals">GSI-OpenSSH Internals</ulink>
page for more details.</simpara>
</preface>
<chapter id="gsiopenssh-developer-beforeyoubegin">
<title>Before you begin</title>
<section id="gsiopenssh-features">
<title>Feature summary</title>
<sidebar>
<simpara>Supported Features</simpara>
<itemizedlist>
<listitem>
<simpara>
The <emphasis role="strong"><literal>gsissh</literal></emphasis> command provides a secure remote login service with forwarding of X.509 proxy credentials.
</simpara>
</listitem>
<listitem>
<simpara>
The <emphasis role="strong"><literal>gsiscp</literal></emphasis> and <emphasis role="strong"><literal>gsisftp</literal></emphasis> commands provide a secure file transfer service authenticated with X.509 proxy credentials, mimicking the <emphasis role="strong"><literal>rcp/scp</literal></emphasis> and <emphasis role="strong"><literal>ftp/sftp</literal></emphasis> commands.
</simpara>
</listitem>
<listitem>
<simpara>
All standard OpenSSH features are supported, excluding Kerberos authentication. Kerberos authentication is <emphasis role="strong">not</emphasis> compatible with GSI-enabled OpenSSH.
</simpara>
</listitem>
<listitem>
<simpara>
The GSI-OpenSSH server can replace the standard system SSH server in typical environments.
</simpara>
</listitem>
<listitem>
<simpara>
If no username is given on the command-line, GSI-OpenSSH automatically determines the username that corresponds to the X.509 proxy certificate subject in the server&#8217;s <literal>grid-mapfile</literal>.
</simpara>
</listitem>
</itemizedlist>
<simpara>Deprecated Features</simpara>
<itemizedlist>
<listitem>
<simpara>
None
</simpara>
</listitem>
</itemizedlist>
</sidebar>
</section>
<section id="gsiopenssh-platforms">
<title>Tested platforms</title>
<simpara>Tested Platforms for GSI-OpenSSH</simpara>
<itemizedlist>
<listitem>
<simpara>
Mac OS X 10.5
</simpara>
</listitem>
<listitem>
<simpara>
x86/x86_64 GNU/Linux
</simpara>
</listitem>
<listitem>
<simpara>
PPC AIX 5.3
</simpara>
</listitem>
<listitem>
<simpara>
Sun4u Solaris 5.10
</simpara>
</listitem>
</itemizedlist>
</section>
<section id="gsiopenssh-compatibility">
<title>Backward compatibility summary</title>
<simpara>GSI-OpenSSH is backward compatible.</simpara>
</section>
<section id="gsiopenssh-dependencies">
<title>Technology dependencies</title>
<simpara>GSI-OpenSSH depends on the following GT components:</simpara>
<itemizedlist>
<listitem>
<simpara>
<ulink url=""></ulink>
</simpara>
</listitem>
</itemizedlist>
<simpara>GSI-OpenSSH depends on the following 3rd party software:</simpara>
<itemizedlist>
<listitem>
<simpara>
<ulink url="http://www.openssh.org/">OpenSSH</ulink>
</simpara>
</listitem>
</itemizedlist>
</section>
<section id="gsi-openssh-security-considerations">
<title>GSI-OpenSSH Security Considerations</title>
<simpara>GSI-OpenSSH is a modified version of <ulink url="http://www.openssh.org/">OpenSSH</ulink>
and includes full OpenSSH functionality. For more information on OpenSSH
security, see the <ulink url="http://www.openssh.org/security.html">OpenSSH Security</ulink>
page.</simpara>
</section>
</chapter>
<chapter id="gsiopenssh-developer-scenarios">
<title>Usage scenarios</title>
<simpara>The GSI-OpenSSH interface is through command-line tools only.</simpara>
</chapter>
<chapter id="gsiopenssh-developer-tutorials">
<title>Tutorials</title>
<simpara>There are no tutorials available at this time</simpara>
</chapter>
<chapter id="gsiopenssh-developer-archdes">
<title>Architecture and design overview</title>
<simpara>See the <ulink url="http://dev.globus.org/wiki/GSI-OpenSSH/Internals">GSI-OpenSSH
Internals</ulink> page.</simpara>
</chapter>
<chapter id="gsiopenssh-cmd">
<title>GSI-OpenSSH Commands</title>
<simpara>The <ulink url="#gsissh">gsissh</ulink>, <ulink url="#gsiscp">gsiscp</ulink>, and <ulink url="#gsisftp">gsiftp</ulink> commands provide
the same interfaces as the standard OpenSSH <emphasis role="strong">ssh</emphasis>, <emphasis role="strong">scp</emphasis>, and
<emphasis role="strong">sftp</emphasis> commands, respectively, with the added ability to perform X.509
proxy credential authentication and delegation.</simpara>
<section id="gsissh">
<title>GSISSH(1)</title>
<section id="_name">
<title>NAME</title>
<simpara>gsissh - Secure remote login</simpara>
</section>
<section id="_synopsis">
<title>SYNOPSIS</title>
<simpara><emphasis role="strong"><literal>gsissh</literal></emphasis></simpara>
</section>
<section id="_tool_description">
<title>Tool description</title>
<simpara>Use the <emphasis role="strong">gsissh</emphasis> command to securely login to a remote machine.</simpara>
</section>
<section id="_command_syntax">
<title>Command syntax</title>
<simpara><emphasis role="strong">gsissh</emphasis> [-l login_name] hostname | <ulink url="mailto:user@hostname">user@hostname</ulink> [command]</simpara>
</section>
</section>
<section id="gsiscp">
<title>GSISCP(1)</title>
<section id="_name_2">
<title>NAME</title>
<simpara>gsiscp - Secure remote file copy</simpara>
</section>
<section id="_synopsis_2">
<title>SYNOPSIS</title>
<simpara><emphasis role="strong"><literal>gsiscp</literal></emphasis></simpara>
</section>
<section id="_tool_description_2">
<title>Tool description</title>
<simpara>Use the <emphasis role="strong">gsiscp</emphasis> command to securely copy files to or from a remote
machine.</simpara>
</section>
<section id="_command_syntax_2">
<title>Command syntax</title>
<simpara><emphasis role="strong">gsiscp</emphasis> [-P port] [[user@]host1:]file1 [&#8230;] [[user@]host2:]destfile</simpara>
</section>
</section>
<section id="gsisftp">
<title>GSISFTP(1)</title>
<section id="_name_3">
<title>NAME</title>
<simpara>gsisftp - Secure file transfer</simpara>
</section>
<section id="_synopsis_3">
<title>SYNOPSIS</title>
<simpara><emphasis role="strong"><literal>gsisftp</literal></emphasis></simpara>
</section>
<section id="_tool_description_3">
<title>Tool description</title>
<simpara>The <emphasis role="strong">gsisftp</emphasis> command provides an interactive interface for
transferring files to and from remote machines.</simpara>
</section>
<section id="_command_syntax_3">
<title>Command syntax</title>
<simpara><emphasis role="strong">gsisftp</emphasis> [[user@host[:dir[/]]] ]</simpara>
</section>
</section>
</chapter>
<chapter id="gsiopenssh-configuring">
<title>Configuring</title>
<simpara>The GSI-enabled OpenSSH software is installed with a default set of
configuration files, described below. You may want to modify the
<literal>ssh_config</literal> file before using the clients and the  file before using
the clients and the <literal>sshd_config</literal> file before using the server.  file
before using the server.</simpara>
<simpara>If the GSI-enabled OpenSSH install script finds existing SSH key pairs,
it will create symbolic links to them rather than generating new key
pairs. The SSH key pairs are not required for GSI authentication.
However, if you wish to support other SSH authentication methods, make
sure the sshd (running as root) can read the key pair files (i.e.,
beware of NFS mounts with root_squash). If running multiple sshds on a
system, we recommend configuring them so they all use the same key pairs
(i.e., use symbolic links) to avoid client-side confusion.</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>$GLOBUS_LOCATION/etc/ssh/moduli</literal>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>moduli
is a crypto parameter for generating
keys.</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
<literal>$GLOBUS_LOCATION/etc/ssh/ssh_config</literal>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>ssh_config
contains options that are read by ssh, scp, and sftp at run-time. The
installed version is the default provided by OpenSSH, with GSI
authentication and X11Forwarding enabled. You may need to customize this
file for compatibility with your system SSH installation (i.e., compare
it with
/etc/ssh/ssh_config).</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
<literal>$GLOBUS_LOCATION/etc/ssh/ssh_host_key[.pub]</literal>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>Your
system&#8217;s RSA public-/private-key pair for SSH protocol 1
communications.</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
<literal>$GLOBUS_LOCATION/etc/ssh/ssh_host_dsa[.pub]</literal>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>Your
system&#8217;s DSA public-/private-key pair for SSH protocol 2
communications.</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
<literal>$GLOBUS_LOCATION/etc/ssh/ssh_host_rsa[.pub]</literal>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>Your
system&#8217;s RSA public-/private-key pair for SSH protocol 2
communications.</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
<literal>$GLOBUS_LOCATION/etc/ssh/ssh_prng_cmds</literal>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>ssh_prng_cmds
contains paths to a number of files that ssh-keygen may need to use if
your system does not have a built-in entropy pool (like
/dev/random).</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
<literal>$GLOBUS_LOCATION/etc/ssh/sshd_config</literal>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>sshd_config
contains options that are read by sshd when it starts up. The installed
version is the default provided by OpenSSH, with X11Forwarding enabled.
You may need to customize this file for compatibility with your system
SSH installation (i.e., compare it with /etc/ssh/sshd_config). For
example, to enable PAM authentication, you may need to set "UsePAM yes"
in this
file.</simpara>
</sidebar>
</chapter>
<chapter id="gsiopenssh-developer-env">
<title>Environment variable interface</title>
<section id="gsiopenssh-env-var">
<title>Environmental variables for GSI-OpenSSH</title>
<simpara>The GSI-enabled OpenSSHD needs to be able to find certain files and
directories in order to properly function.</simpara>
<simpara>The items that OpenSSHD needs to be able to locate, their default
location and the environment variable to override the default location
are:</simpara>
<itemizedlist>
<listitem>
<simpara>
<emphasis role="strong">Host key</emphasis>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>Default
location: /etc/grid-security/hostkey.pemOverride with X509_USER_KEY
environment variable</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
Host certificate
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>Default
location: /etc/grid-security/hostcert.pemOverride with X509_USER_CERT
environment
variable</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
Grid map file
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>Default
location: /etc/grid-security/grid-mapfileOverride with GRIDMAP
environment
variable</simpara>
</sidebar>
<itemizedlist>
<listitem>
<simpara>
<emphasis role="strong">Certificate directory</emphasis>
</simpara>
</listitem>
</itemizedlist>
<sidebar>
<simpara>Default
location: /etc/grid-security/certificatesOverride with X509_CERT_DIR
environment variable</simpara>
</sidebar>
</section>
</chapter>
<chapter id="gsiopenssh-developer-troubleshooting">
<title>Troubleshooting</title>
<section id="gsiopenssh-gterrors">
<title>Common GT Errors</title>
<section id="gsiopenssh-error-codes">
<title>Errors</title>
<table id="gsiopenssh-errors-table"
frame="all"
rowsep="1" colsep="1"
>
<title>GSI-OpenSSH Errors</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<thead>
<row>
<entry align="left" valign="top"> Error Code </entry>
<entry align="left" valign="top"> Definition </entry>
<entry align="left" valign="top"> Possible Solutions</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>GSS-API error Failure acquiring GSSAPI credentials: GSS_S_CREDENTIALS_EXPIRED</literal></simpara></entry>
<entry align="left" valign="top"><simpara>This means that your proxy certificate has expired.</simpara></entry>
<entry align="left" valign="top"><simpara>Run <ulink url="../../gsic/pi/index.html#grid-proxy-init"><emphasis role="strong"><literal>grid-proxy-init</literal></emphasis></ulink> to
  acquire a new proxy certificate, then run <literal>gsissh</literal> again.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>&#8230;no proxy credentials&#8230;</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Failing to run grid-proxy-init to create a user proxy with which to connect
  will result in the client notifying you that no local credentials exist. Any
  attempt to authenticate using GSI will fail in this case.</simpara></entry>
<entry align="left" valign="top"><simpara>Verify that your GSI proxy has been properly initialized via
  <ulink url="../../gsic/pi/index.html#grid-proxy-info"><emphasis role="strong"><literal>grid-proxy-info</literal></emphasis></ulink>.  If
  you need to initialize the proxy, use the command
  <ulink url="../../gsic/pi/index.html#grid-proxy-init"><emphasis role="strong"><literal>grid-proxy-init</literal></emphasis></ulink>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>&#8230;bad file system permissions on private key; key must only be readable by
  the user&#8230;</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The host key that the SSH server is using for GSI authentication must only be
  readable by the user which owns it.  Any other permissions will cause this
  error.</simpara></entry>
<entry align="left" valign="top"><simpara>Make sure that the host key&#8217;s UNIX permissions are mode 400 (that is, it
  should only have mode readable for the user that owns the file,
  and no other mode bits should be set).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>&#8230;gssapi received empty username; failed to set username from gssapi
  context; Failed external-keyx for &lt;user&gt; from &lt;host&gt; &lt;port&gt;&#8230;</literal></simpara></entry>
<entry align="left" valign="top"><simpara>If the server was passed an "implicit username" (i.e. requested to map the
  incoming connection to a username based on some contextual clues such as the
  certificate&#8217;s subject), and no entry exists in the grid-mapfile for the
  incoming connection&#8217;s certificate subject, the server should output a clue
  that states it is unable to set the username against which to authenticate.</simpara></entry>
<entry align="left" valign="top"><simpara>Add an entry for the user to the
  <ulink url="../../gsic/pi/index.html#gsic-env-gridmapfile">gridmap file</ulink>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>&#8230;INTERNAL ERROR: authenticated invalid user xxx&#8230;</literal></simpara></entry>
<entry align="left" valign="top"><simpara>If the subject name given in the system&#8217;s grid-mapfile points to a
  non-existent user, the server will give an internal error which is best
  caught when it is running in debugging mode.</simpara></entry>
<entry align="left" valign="top"><simpara>Add a new account to the system matching the username pointed at by the
  user&#8217;s subject in the grid-mapfile.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>&#8230;gssapi received empty username; no suitable client data; failed to set username from gssapi context; Failed external-keyx for &lt;user&gt; from &lt;host&gt; &lt;port&gt;&#8230;</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Should the user attempt to connect without first creating a proxy
  certificate, or if the user is connecting via a SSH client that does not
  support GSI authentication, the server will note that no GSSAPI data was sent
  to it. Verify that the client is able to connect through another GSI service
  (such as the gatekeeper) to make sure that the user&#8217;s proxy has been created
  correctly.</simpara></entry>
<entry align="left" valign="top"><simpara>Verify that you are using a GSI-enabled SSH client and that your GSI proxy
  has been properly initialized via
  <ulink url="../../gsic/pi/index.html#grid-proxy-info"><emphasis role="strong"><literal>grid-proxy-info</literal></emphasis></ulink>. If
  you need to initialize this proxy, use the command
  <ulink url="../../gsic/pi/index.html#grid-proxy-init"><emphasis role="strong"><literal>grid-proxy-init</literal></emphasis></ulink>.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
</section>
<section id="gsiopenssh-errors">
<title>Additional GSI-OpenSSH Troubleshooting</title>
<simpara>Please see the
<ulink url="http://grid.ncsa.illinois.edu/ssh/ts%5fcommon.html">GSI-OpenSSH
Troubleshooting Page</ulink> at NCSA.</simpara>
</section>
</chapter>
<chapter id="gsiopenssh-developer-relateddocs">
<title>Related Documentation</title>
<simpara>Please see the <ulink url="http://grid.ncsa.uiuc.edu/ssh/">GSI-OpenSSH Home Page</ulink> at
NCSA for more information.</simpara>
</chapter>
</book>
